name: release

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

defaults:
  run:
    shell: bash

jobs:
  release-please:
    if: github.actor != 'nektos/act'

    runs-on: ubuntu-latest

    outputs:
      pr: ${{ steps.release-please.outputs.pr }}
      releases_created: ${{ steps.release-please.outputs.releases_created }}
      paths_released: ${{ steps.release-please.outputs.paths_released }}

    steps:
      - uses: google-github-actions/release-please-action@e4dc86ba9405554aeba3c6bb2d169500e7d3b4ee # v4
        id: release-please
        with:
          config-file: .github/.release-please-config.json
          manifest-file: .github/.release-please-manifest.json

      - name: Echo release-please outputs
        if: steps.release-please.outputs
        run: echo '${{ toJson(steps.release-please) }}'

  publish:
    needs: release-please

    if: needs.release-please.outputs.releases_created && needs.release-please.outputs.paths_released

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Publish released packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for path in ${{ needs.release-please.outputs.paths_released }}; do
            pnpm --filter "$path" publish
          done
