# Refer for explanation to following link:
# https://github.com/evilmartians/lefthook
#
# Run the command to test:
#   npx -y lefthook run -v <hook-name>
#
# Examples:
#   npx -y lefthook run -v pre-commit
#   npx -y lefthook run -v commit-msg
#   npx -y lefthook run -v post-merge

extends:
  # - packages/lefthook-config/hooks/commit-msg/format-prettier.yaml
  - packages/lefthook-config/hooks/commit-msg/lint/file-extension/yaml.yaml

pre-commit:
  parallel: true

  commands:
    lint-markdown:
      glob: '*.md'
      run: npx -y markdownlint-cli2 {staged_files}

    lint-file-extension-yaml:
      files: git diff --name-only --staged
      glob: '*.yml'
      run: echo "Error! ".yml" extension found, please use ".yaml" instead." && exit 1

    lint-file-extension-test:
      files: git diff --name-only --staged
      glob: '*.spec.{js,ts}'
      run: echo "Error! ".spec.{js,ts}" extension found, please use ".test.ts" instead." && exit 1

    lint-file-extension-storybook:
      files: git diff --name-only --staged
      glob: '*.story.{tsx,mdx}'
      run: echo "Error! "*.story.{tsx,mdx}" extension found, please use "*.stories.{tsx,mdx}" instead." && exit 1

commit-msg:
  parallel: true

  commands:
    commitlint:
      run: npx -y commitlint --edit {1} --verbose

    cspell:
      run: npx -y @nozomiishii/cspell-config@latest {1}

post-merge:
  parallel: true

  commands:
    # If you have set 'git config pull.rebase true', use the 'post-rewrite' hook instead of the 'post-merge' hook.
    update-node-modules:
      files: git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD
      glob: '**/{package.json,pnpm-lock.yaml,yarn.lock,package-lock.json}'
      run: |
        if [ -f "pnpm-lock.yaml" ]; then
          echo "ðŸ¥Š Installing dependencies with pnpm..."
          pnpm install
          exit 0
        fi

        if [ -f "yarn.lock" ]; then
          echo "ðŸ¥Š Installing dependencies with yarn..."
          yarn install
          exit 0
        fi

        if [ -f "package-lock.json" ]; then
          echo "ðŸ¥Š Installing dependencies with npm..."
          npm install
          exit 0
        fi

    delete-merged-branches:
      run: git branch --merged | grep -Ev '\*|master|main|dev|develop|development|stag|staging|prod|production' | xargs git branch -d; git fetch --prune;
